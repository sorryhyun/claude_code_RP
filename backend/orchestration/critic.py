"""
Critic agent handling.

This module handles critic agents that observe conversations and provide
diagnostic feedback. Critics don't participate directly in chat but
analyze and report on conversation quality.
"""

import asyncio
import logging
import os
from datetime import datetime
from typing import TYPE_CHECKING, List

if TYPE_CHECKING:
    from domain.contexts import OrchestrationContext

    from .response_generator import ResponseGenerator

logger = logging.getLogger("Critic")


def save_critic_report(agent_name: str, response_text: str, thinking_text: str = ""):
    """
    Save a critic agent's diagnostic report to reports/report.md

    Args:
        agent_name: Name of the critic agent
        response_text: The diagnostic report content
        thinking_text: Optional thinking process
    """
    try:
        # Create reports directory if it doesn't exist
        reports_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), "reports")
        os.makedirs(reports_dir, exist_ok=True)

        # Create timestamped report file path to avoid overwriting
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        # Sanitize agent name for filename (replace spaces and special chars with underscores)
        safe_agent_name = "".join(c if c.isalnum() else "_" for c in agent_name)
        report_filename = f"{safe_agent_name}_{timestamp}.md"
        report_path = os.path.join(reports_dir, report_filename)

        # Format report with timestamp and metadata
        readable_timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        report_content = f"""# Diagnostic Report
**Generated by:** {agent_name}
**Timestamp:** {readable_timestamp}

---

{response_text}
"""

        # Optionally append thinking process if available
        if thinking_text:
            report_content += f"\n\n---\n\n## Thinking Process\n\n{thinking_text}\n"

        # Write to file
        with open(report_path, "w", encoding="utf-8") as f:
            f.write(report_content)

        logger.info(f"üìù Critic report saved to {report_path}")

    except Exception as e:
        logger.error(f"‚ùå Failed to save critic report: {e}")


async def process_critic_feedback(
    orch_context: "OrchestrationContext",
    critic_agents: List,
    user_message_content: str,
    response_generator: "ResponseGenerator",
):
    """
    Generate feedback from critic agents after conversation rounds.
    Critics observe the conversation but don't participate directly.
    Their feedback is stored but not broadcast to the main chat.

    Args:
        orch_context: OrchestrationContext containing db, room_id, agent_manager
        critic_agents: List of critic agent objects
        user_message_content: The original user message
        response_generator: ResponseGenerator instance for generating responses
    """
    logger.info(f"üîç Processing critic feedback | Room: {orch_context.room_id} | Critics: {len(critic_agents)}")

    # Create tasks for all critics to run concurrently
    tasks = [
        response_generator.generate_response(
            orch_context=orch_context,
            agent=critic,
            user_message_content=user_message_content,
            is_critic=True,  # Flag to indicate this is a critic
        )
        for critic in critic_agents
    ]

    # Wait for all critics to complete
    results = await asyncio.gather(*tasks, return_exceptions=True)

    # Log any errors
    for i, result in enumerate(results):
        if isinstance(result, Exception):
            logger.error(f"‚ùå Critic {critic_agents[i].name} error: {result}")
        else:
            logger.info(f"‚úÖ Critic {critic_agents[i].name} feedback stored")
